    @model CombinedResponseDto


    @if (Model.ShowForm)
    {



        @foreach (var comment in Model.Comments)
        {
            <div class="questions">


                <div class="question">
                    <div class="question-container">

                        <div class="user-info">

                            <img src="/Linkhtml/assets/user.jpg" alt="Kullanıcı Adı" class="user-photo" />

                            <div class="userhome-infotext">
                                <p class="usernamehome">@comment.FirstName @comment.SurName</p><br />
                                <p class="userName"><a href="https://localhost:7132/profile/@comment.AppUserID">#@comment.UserName</a></p>
                            </div>

                            <form action="/ShareProfile/RemoveComment" method="post">
                                <input type="hidden" name="id" value="@comment.ProfileCommentID" />
                                <button type="submit" class="remove-comment-button">X</button>
                            </form>

                        </div>
                        <p class="question-text">@comment.Comment</p>
                        <div class="detailhome">
                            <a href="#" class="icon-link like-button" data-id="@comment.ProfileCommentID" data-entity-type="Comment"><i class="ri-heart-line"></i></a>
                            <a href="#" class="icon-link like-count" data-id="@comment.ProfileCommentID">@comment.Like</a>
                            <a href="#" class="like-list" data-id="@comment.ProfileCommentID" data-entity-type="Comment">beğenenleri gör</a>

                            <a href="#" class="icon-link right-icon"><i class="ri-star-line"></i> @DateTime.Now.ToString("HH:mm")</a>

                        </div>

                    </div>


                    <div class="answers">
                        @if (Model.CommentAnswers.ContainsKey(comment.ProfileCommentID))
                        {
                            @foreach (var answer in Model.CommentAnswers[comment.ProfileCommentID])
                            {
                                <div class="answer">
                                    <div class="user-info">
                                        <img src="/Linkhtml/assets/user.jpg" alt="@answer.UserName" class="user-photo">
                                        <div class="userhome-infotext">
                                            <p class="usernamehome">@answer.FirstName @answer.SurName</p><br />
                                            <p class="userName"><a href="https://localhost:7132/profile/@comment.AppUserID">#@answer.UserName</a></p>
                                        </div>
                                    </div>
                                    <p class="answer-text">@answer.AnswerText</p>

                                    <div class="detailhome">
                                        <a href="#" class="icon-link like-button" data-id="@answer.AnswerID" data-entity-type="Answer"><i class="ri-heart-line"></i></a>
                                        <a href="#" class="icon-link like-count" data-id="@answer.AnswerID">@answer.LikeCount</a>
                                        <a href="#" class="like-list" data-id="@answer.AnswerID" data-entity-type="Answer">beğenenleri gör</a>

                                        <a href="#" class="icon-link right-icon"><i class="ri-star-line"></i> @DateTime.Now.ToString("HH:mm")</a>

                                    </div>
                                </div>

                            }
                        }
                        else
                        {
                            <p>Henüz yanıt yok.</p>
                        }
                    </div>

                    @if (!Model.CommentAnswers.ContainsKey(comment.ProfileCommentID) || Model.CommentAnswers[comment.ProfileCommentID].Count == 0)
                    {
                        <form id="add-answer-form" asp-action="AddAnswer" method="post">
                            <input type="hidden" name="ProfileCommentID" value="@comment.ProfileCommentID" />
                            <textarea type="text" name="AnswerText" placeholder="Yorumun Cevabını yaz" required></textarea>
                            <button id="dynamic-button" class="icon" type="submit">
                                <span class="add-text">Kaydet</span>
                            </button>
                        </form>
                    }
                </div>
            </div>

        }
    }
    else
    {
        <div class="ask-question">
            <form id="add-comment-form" asp-action="AddComment" method="post">
                <textarea type="Comment" id="LinkName" name="Comment" placeholder="Yorumunuzu yazın"></textarea>
                <button type="submit" class="comment-button">Gönder</button>
                <input type="hidden" name="id" value="@Model.GetAppUserDto.Id" />

            </form>
        </div>
        <div class="questions">
            @foreach (var comment in Model.Comments.Where(c => !c.Hidden))
            {
                <div class="question">
                    <div class="question-container">

                        <div class="user-info">
                            <img src="/Linkhtml/assets/user.jpg" alt="@comment.UserName" class="user-photo">
                            <div class="userhome-infotext">
                                <p class="usernamehome">@comment.FirstName @comment.SurName</p><br />
                                <p class="userName"><a href="https://localhost:7132/profile/@comment.AppUserID">#@comment.UserName</a></p>
                            </div>

                        </div>
                        <p class="question-text">@comment.Comment</p>
                        <div class="detailhome">
                            <a href="#" class="icon-link like-button" data-id="@comment.ProfileCommentID" data-entity-type="Comment"><i class="ri-heart-line"></i></a>
                            <a href="#" class="icon-link like-count" data-id="@comment.ProfileCommentID">@comment.Like</a>
                            <a href="#" class="like-list" data-id="@comment.ProfileCommentID" data-entity-type="Comment">beğenenleri gör</a>

                            <a href="#" class="icon-link right-icon"><i class="ri-star-line"></i> @DateTime.Now.ToString("HH:mm")</a>

                        </div>
                    </div>
                    <div class="answer">
                        @foreach (var answer in Model.CommentAnswers.GetValueOrDefault(comment.ProfileCommentID, new List<AnswerDto>()))
                        {
                            <div class="user-info">
                                <img src="/Linkhtml/assets/user.jpg" alt="@answer.UserName" class="user-photo">
                                <div class="userhome-infotext">
                                    <p class="usernamehome">@answer.FirstName @answer.SurName</p><br />
                                    <p class="userName"><a href="https://localhost:7132/profile/@comment.AppUserID">#@answer.UserName</a></p>
                                </div>
                            </div>
                            <p class="answer-text">@answer.AnswerText</p>

                            <div class="detailhome">
                                <a href="#" class="icon-link like-button" data-id="@answer.AnswerID" data-entity-type="Answer"><i class="ri-heart-line"></i></a>
                                <a href="#" class="icon-link like-count" data-id="@answer.AnswerID">@answer.LikeCount</a>
                                <a href="#" class="like-list" data-id="@answer.AnswerID" data-entity-type="Answer">beğenenleri gör</a>

                                <a href="#" class="icon-link right-icon"><i class="ri-star-line"></i> @DateTime.Now.ToString("HH:mm")</a>

                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/Home/GetToken', {
            method: 'POST',
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                const token = data.token;

                let likerPage = 1;
                const likerPageSize = 5;
                let isLoadingLikers = false;
                let allLikersLoaded = false;

                let currentEntityId;
                let currentEntityType;

                let swalInstance;

                function sendLikeRequest(id, entityType) {
                    const likeCommand = {
                        Id: id,
                        EntityType: entityType
                    };

                    fetch('https://localhost:7048/api/Comment/CreateLike', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(likeCommand)
                    })
                        .then(response => response.json())
                        .then(result => {
                            console.log(result.message);
                        })
                        .catch(error => console.error('Error:', error));
                }

                function fetchLikes(id, entityType) {
                    if (isLoadingLikers || allLikersLoaded) return;

                    isLoadingLikers = true;

                    fetch(`https://localhost:7048/api/Comment/GetLikersInf?entityId=${id}&entityType=${entityType}&page=${likerPage}&pageSize=${likerPageSize}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                        .then(response => response.json())
                        .then(likers => {
                            if (likers.length < likerPageSize) {
                                allLikersLoaded = true;
                            } else {
                                likerPage++;
                            }
                            updateLikersInUI(likers);
                            isLoadingLikers = false;
                        })
                        .catch(error => {
                            console.error('Error fetching likers:', error);
                            Swal.fire('Hata', 'Beğenenleri alırken bir hata oluştu.', 'error');
                            isLoadingLikers = false;
                        });
                }

                function updateLikersInUI(likers) {
                    const userList = likers.map(user => `
                        <div class="usersearch" data-id="${user.userID}" style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer;">
                            <img src="/Linkhtml/assets/user.jpg" alt="${user.firstName} ${user.surName}" class="userhome-photo" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                            <div class="userhome-infotext">
                                <p class="usernamehome" style="margin: 0; font-weight: bold;">${user.firstName} ${user.surName}</p>
                                <p class="userName" style="text-align: left; margin-left: 0; padding-left: 0; color: gray;">#${user.userName}</p>
                            </div>
                        </div>
                    `).join('');

                    if (!swalInstance) {
                        swalInstance = Swal.fire({
                            title: 'Beğenenler',
                            html: `<div class="liker-list-container" style="max-height: 300px; overflow-y: auto;">${userList}</div>`,
                            width: '30%',
                            confirmButtonText: 'Tamam'
                        });

                        document.querySelector('.liker-list-container').addEventListener('scroll', function () {
                            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
                                fetchLikes(currentEntityId, currentEntityType);
                            }
                        });
                    } else {
                        const container = document.querySelector('.liker-list-container');
                        container.innerHTML += userList;
                    }
                }

                document.body.addEventListener('click', function (event) {
                    const likeButton = event.target.closest('.like-button');
                    if (likeButton) {
                        event.preventDefault();
                        const id = parseInt(likeButton.getAttribute('data-id'));
                        const entityType = likeButton.getAttribute('data-entity-type');
                        sendLikeRequest(id, entityType);
                    }

                    const likeList = event.target.closest('.like-list');
                    if (likeList) {
                        event.preventDefault();
                        currentEntityId = parseInt(likeList.getAttribute('data-id'));
                        currentEntityType = likeList.getAttribute('data-entity-type');
                        likerPage = 1;
                        allLikersLoaded = false;

                        if (swalInstance) {
                            swalInstance.close();
                            swalInstance = null;
                        }

                        updateLikersInUI([]);
                        fetchLikes(currentEntityId, currentEntityType);
                    }
                });
            })
            .catch(error => console.error('Error fetching token:', error));
    });
</script>

